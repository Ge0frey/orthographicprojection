<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>D3 Globe (Orthographic Projection)</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/topojson@3"></script>
<style>
  body {
    background: #111;
    margin: 0;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  svg {
    cursor: grab;
  }
  svg:active {
    cursor: grabbing;
  }
</style>
</head>

<body>

<svg id="globe" width="800" height="800"></svg>

<script>
const width = 800;
const height = 800;

const svg = d3.select("#globe");

const projection = d3.geoOrthographic()
    .scale(360)
    .translate([width / 2, height / 2])
    .clipAngle(90);

const path = d3.geoPath(projection);
const graticule = d3.geoGraticule();

// Sphere
svg.append("path")
    .datum({ type: "Sphere" })
    .attr("class", "sphere")
    .attr("fill", "#1a1a1a")
    .attr("stroke", "#333")
    .attr("stroke-width", 1)
    .attr("d", path);

// Graticule lines
svg.append("path")
  .datum(graticule)
  .attr("class", "graticule")
  .attr("fill", "none")
  .attr("stroke", "#444")
  .attr("stroke-width", 0.5)
  .attr("d", path);

let land, borders;

// Load world map
d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/land-110m.json")
  .then(worldData => {
      land = topojson.feature(worldData, worldData.objects.land);

      svg.append("path")
        .datum(land)
        .attr("class", "land")
        .attr("fill", "#4caf50")
        .attr("stroke", "#222")
        .attr("stroke-width", 0.5)
        .attr("d", path);

      d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json")
        .then(countryData => {
            borders = topojson.mesh(countryData, countryData.objects.countries, (a, b) => a !== b);

            svg.append("path")
              .datum(borders)
              .attr("class", "borders")
              .attr("fill", "none")
              .attr("stroke", "#111")
              .attr("stroke-width", 0.5)
              .attr("d", path);
        });
  });

// Drag rotation
let rotate = [0, 0];
let velocity = 0.007; // auto-rotation speed
let previousMousePos;

const drag = d3.drag()
  .on("start", (event) => {
      velocity = 0; // stop auto rotation
      previousMousePos = [event.x, event.y];
  })
  .on("drag", (event) => {
      const dx = event.x - previousMousePos[0];
      const dy = event.y - previousMousePos[1];

      rotate = projection.rotate();
      const newRotate = [
        rotate[0] + dx * 0.5,
        rotate[1] - dy * 0.5
      ];
      projection.rotate(newRotate);

      previousMousePos = [event.x, event.y];

      redraw();
  })
  .on("end", () => {
      velocity = 0.007; // resume rotation
  });

svg.call(drag);

// Auto rotation
d3.timer(() => {
  if (velocity !== 0) {
      const r = projection.rotate();
      r[0] += velocity * 50;
      projection.rotate(r);
      redraw();
  }
});

// Redraw function
function redraw() {
    svg.select(".sphere").attr("d", path);
    svg.select(".graticule").attr("d", path);
    if (land) svg.select(".land").attr("d", path);
    if (borders) svg.select(".borders").attr("d", path);
}
</script>

</body>
</html>
